<html>

<head>
  <style>
    body {
      font-family: monospace;
    }

    #event {
      margin: 2em 0;
      min-height: 200px;
      min-width: 700px;
    }
  </style>
  <script>

    const STORAGE_TYPE = 'localStorage'

    // Function to set localStorage from query string parameters

    const queryParams = {
      STAGE_KEY_NAME: 'stage',
      WRITE_KEY_NAME: 'wk',
      RESET_KEY_NAME: 'reset',
    }

    const Storage = () => {
      const getQueryParams = () => {
        const params = new URLSearchParams(window.location.search)
        const stage = params.get(queryParams.STAGE_KEY_NAME)
        const writeKey = params.get(queryParams.WRITE_KEY_NAME)
        const reset = params.get(queryParams.RESET_KEY_NAME)
        return { stage, writeKey, reset }
      }

      console.log('Query params allowed:', JSON.stringify(Object.values(queryParams)))
      console.log('Query params found:', JSON.stringify(getQueryParams()))

      const clearStorage = () => {
        window[STORAGE_TYPE].removeItem(queryParams.STAGE_KEY_NAME)
        window[STORAGE_TYPE].removeItem(queryParams.WRITE_KEY_NAME)
      }
      const setStorage = () => {
        const { stage, writeKey, reset } = getQueryParams()

        if (stage !== null) {
          window[STORAGE_TYPE].setItem(queryParams.STAGE_KEY_NAME, stage)
        }
        if (writeKey !== null) {
          window[STORAGE_TYPE].setItem(queryParams.WRITE_KEY_NAME, writeKey)
        }
        if (reset !== null) {
          clearStorage()
        }
      }

      setStorage()
      return {
        getStorage: () => {
          return {
            stage: window[STORAGE_TYPE].getItem(queryParams.STAGE_KEY_NAME),
            writeKey: window[STORAGE_TYPE].getItem(queryParams.WRITE_KEY_NAME),
          }
        },
      }
    }

    // Set localStorage from query string parameters
    const storage = Storage()
    // Retrieve values from localStorage or fall back to environment variables
    const isStage =
      storage.getStorage().stage === 'true'
    const writeKey = storage.getStorage().writeKey
  </script>
  <!-- Load Segment (find and replace 'MY_WRITEKEY')  -->
  <script>
    !function () {
      var i = "analytics", analytics = window[i] = window[i] || []; if (!analytics.initialize) if (analytics.invoked) window.console && console.error && console.error("Segment snippet included twice."); else {
        analytics.invoked = !0; analytics.methods = ["trackSubmit", "trackClick", "trackLink", "trackForm", "pageview", "identify", "reset", "group", "track", "ready", "alias", "debug", "page", "screen", "once", "off", "on", "addSourceMiddleware", "addIntegrationMiddleware", "setAnonymousId", "addDestinationMiddleware", "register"]; analytics.factory = function (e) { return function () { if (window[i].initialized) return window[i][e].apply(window[i], arguments); var n = Array.prototype.slice.call(arguments); if (["track", "screen", "alias", "group", "page", "identify"].indexOf(e) > -1) { var c = document.querySelector("link[rel='canonical']"); n.push({ __t: "bpc", c: c && c.getAttribute("href") || void 0, p: location.pathname, u: location.href, s: location.search, t: document.title, r: document.referrer }) } n.unshift(e); analytics.push(n); return analytics } }; for (var n = 0; n < analytics.methods.length; n++) { var key = analytics.methods[n]; analytics[key] = analytics.factory(key) } analytics.load = function (key, n) { var t = document.createElement("script"); t.type = "text/javascript"; t.async = !0; t.setAttribute("data-global-segment-analytics-key", i); t.src = "https://cdn.segment.com/analytics.js/v1/" + key + "/analytics.min.js"; var r = document.getElementsByTagName("script")[0]; r.parentNode.insertBefore(t, r); analytics._loadOptions = n }; analytics._writeKey = writeKey;; analytics.SNIPPET_VERSION = "5.2.0";
        analytics.page();
      }
    }();
  </script>
  <script
    src="https://cdn.jsdelivr.net/npm/@segment/analytics-signals@latest/dist/umd/analytics-signals.umd.js"></script>
  <script>


    if (!writeKey) {
      throw new Error(
        `No writekey provided. please add ?${queryParams.WRITE_KEY_NAME}=<writekey> to the URL`
      )
    }

    const signalsPlugin = new SignalsPlugin({
      ...(isStage ? { apiHost: 'signals.segment.build/v1' } : {}),
      // enableDebugLogging: true,
      // processSignal: processSignalExample,
    })
    signalsPlugin.debug(true)
    console.log(`Loading analytics with WRITEKEY=${writeKey} and STAGE=${isStage}`)
    
    const loadAnalytics = () =>
      analytics
        .load(
          {
            writeKey: writeKey,
            plugins: [signalsPlugin],
            ...(isStage ? { cdnURL: 'https://cdn.segment.build' } : {}),
          },
          {
            ...(isStage
              ? {
                integrations: {
                  'Segment.io': {
                    apiHost: 'api.segment.build/v1',
                  },
                },
              }
              : {}),
          }
        )
      analytics.ready(function () {
        console.log(`Analytics is ready.`)
      })
    analytics.register(signalsPlugin)
    analytics.load(analytics._writeKey)
  </script>

<body>
  <h2>Pass query params (?wk=MY_WRITEKEY&stage=true)</h2>
  <form>
    <textarea name="event" id="event" placeholder="form">
    </textarea>
    <div>
      <input type="text" placeholder="some text box" />
      <input type="number" placeholder="some number input" />
    </div>
  </form>



</body>

</html>
